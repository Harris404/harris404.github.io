({579(){var e=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))(function(i,o){function a(e){try{d(s.next(e))}catch(e){o(e)}}function c(e){try{d(s.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,c)}d((s=s.apply(e,t||[])).next())})};Office.onReady(t=>{t.host===Office.HostType.Excel&&(document.getElementById("imageInput").onchange=w,document.getElementById("batchInsertBtn").onclick=L,document.getElementById("getImagesBtn").onclick=M,document.getElementById("clearPreviewBtn").onclick=b,document.getElementById("confirmScreenshotBtn").onclick=v,document.getElementById("cancelPreviewBtn").onclick=h,function(){const e=document.getElementById("imageModal"),t=document.getElementById("modalClose"),n=document.getElementById("modalPrev"),s=document.getElementById("modalNext");t.onclick=f,e.onclick=t=>{t.target===e&&f()},n.onclick=()=>p(-1),s.onclick=()=>p(1),document.addEventListener("keydown",t=>{e.classList.contains("active")&&("Escape"===t.key&&f(),"ArrowLeft"===t.key&&p(-1),"ArrowRight"===t.key&&p(1))})}(),function(){const t=document.getElementById("pasteArea"),n=document.getElementById("screenshotStatus");t.setAttribute("tabindex","0"),t.onclick=()=>{t.classList.add("active"),t.focus(),n.innerHTML='<div class="status">âœ… ç²˜è´´åŒºåŸŸå·²æ¿€æ´»ï¼Œç°åœ¨æŒ‰ âŒ˜+V ç²˜è´´æˆªå›¾</div>'},t.addEventListener("paste",e=>{u(e)}),document.addEventListener("paste",e=>{u(e)}),t.addEventListener("blur",()=>{setTimeout(()=>{t.classList.remove("active")},300)}),t.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation(),t.classList.add("dragover")}),t.addEventListener("dragenter",e=>{e.preventDefault(),e.stopPropagation(),t.classList.add("dragover")}),t.addEventListener("dragleave",e=>{e.preventDefault(),t.classList.remove("dragover")}),t.addEventListener("drop",t=>{!function(t){e(this,void 0,void 0,function*(){var e;t.preventDefault(),document.getElementById("pasteArea").classList.remove("dragover");const n=document.getElementById("screenshotStatus"),s=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;if(!s||0===s.length)return void(n.innerHTML='<div class="status error">âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶</div>');const i=s[0];i.type.startsWith("image/")?yield g(i,i.name):n.innerHTML='<div class="status error">âŒ è¯·æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶</div>'})}(t)}),document.addEventListener("dragover",e=>e.preventDefault()),document.addEventListener("drop",e=>e.preventDefault())}(),function(){try{const e=Office.context.document.settings.get(r);if(!e)return;const t=JSON.parse(e);for(const e of t){const t=Office.context.document.settings.get(l+e);t&&c.set(e,t)}console.log(`å·²ä»æ–‡æ¡£åŠ è½½ ${c.size} å¼ åŸå›¾æ•°æ®`)}catch(e){console.error("åŠ è½½åŸå›¾æ•°æ®å¤±è´¥:",e)}}())});let t=[],n=[],s=[],i=[],o=0,a="preview";const c=new Map;let d=null;const l="originalImage_",r="originalImageIndex";function m(t,n){return e(this,void 0,void 0,function*(){try{Office.context.document.settings.set(l+t,n);const e=Office.context.document.settings.get(r);let s=e?JSON.parse(e):[];-1===s.indexOf(t)&&(s.push(t),Office.context.document.settings.set(r,JSON.stringify(s))),yield new Promise((e,t)=>{Office.context.document.settings.saveAsync(n=>{var s;n.status===Office.AsyncResultStatus.Succeeded?e():t(new Error((null===(s=n.error)||void 0===s?void 0:s.message)||"ä¿å­˜å¤±è´¥"))})})}catch(e){console.error("ä¿å­˜åŸå›¾åˆ°æ–‡æ¡£å¤±è´¥:",e)}})}function u(t){return e(this,void 0,void 0,function*(){var e,n;t.preventDefault(),t.stopPropagation();const s=document.getElementById("screenshotStatus");s.innerHTML='<div class="status">æ­£åœ¨è¯»å–å‰ªè´´æ¿...</div>';const i=null===(e=t.clipboardData)||void 0===e?void 0:e.items;if(i){for(let e=0;e<i.length;e++){const t=i[e];if(t.type.startsWith("image/")){const e=t.getAsFile();if(e)return void(yield g(e,"ç²˜è´´çš„æˆªå›¾"))}}for(let e=0;e<i.length;e++){const t=i[e];if("file"===t.kind){const e=t.getAsFile();if(e&&e.type.startsWith("image/"))return void(yield g(e,"ç²˜è´´çš„æˆªå›¾"))}}}const o=null===(n=t.clipboardData)||void 0===n?void 0:n.files;if(o&&o.length>0)for(let e=0;e<o.length;e++){const t=o[e];if(t.type.startsWith("image/")||t.name.endsWith(".png")||t.name.endsWith(".jpg"))return void(yield g(t,"ç²˜è´´çš„æˆªå›¾"))}try{if(navigator.clipboard&&navigator.clipboard.read){const e=yield navigator.clipboard.read();for(const t of e){const e=t.types.filter(e=>e.startsWith("image/")||"public.png"===e||"public.tiff"===e);for(const n of e)try{const e=yield t.getType(n),s=new File([e],"clipboard-image.png",{type:"image/png"});return void(yield g(s,"ç²˜è´´çš„æˆªå›¾"))}catch(e){console.log("Failed to get type:",n,e)}for(const e of["image/png","image/jpeg","image/gif","image/webp"])try{const n=yield t.getType(e),s=new File([n],"clipboard-image.png",{type:e});return void(yield g(s,"ç²˜è´´çš„æˆªå›¾"))}catch(e){}}}}catch(e){console.log("Clipboard API error:",e)}s.innerHTML='<div class="status error">âŒ æ— æ³•è¯»å–å‰ªè´´æ¿å›¾ç‰‡<br><small>æç¤ºï¼šmacOSæˆªå›¾åï¼Œè¯·å°è¯•å…ˆæ‰“å¼€"é¢„è§ˆ"åº”ç”¨ç²˜è´´ï¼Œå†å¤åˆ¶ä¸€æ¬¡</small></div>'})}function g(t,n){return e(this,void 0,void 0,function*(){const e=document.getElementById("screenshotStatus"),s=document.getElementById("screenshotPreviewArea"),i=document.getElementById("screenshotPreviewImg");try{e.innerHTML='<div class="status">æ­£åœ¨åŠ è½½å›¾ç‰‡é¢„è§ˆ...</div>';const o=yield new Promise((e,n)=>{const s=new FileReader;s.onload=()=>e(s.result),s.onerror=()=>n(new Error("è¯»å–å›¾ç‰‡å¤±è´¥")),s.readAsDataURL(t)}),a=o.split(",")[1];d={dataUrl:o,base64:a,name:n},i.src=o,s.style.display="block",e.innerHTML='<div class="status">ğŸ“¸ é¢„è§ˆå·²åŠ è½½ï¼Œè¯·ç¡®è®¤ååµŒå…¥å•å…ƒæ ¼</div>'}catch(t){e.innerHTML='<div class="status error">âŒ é”™è¯¯: '+t.message+"</div>"}})}function v(){return e(this,void 0,void 0,function*(){const t=document.getElementById("screenshotStatus"),n=document.getElementById("screenshotPreviewArea");if(d)try{t.innerHTML='<div class="status">æ­£åœ¨åµŒå…¥å›¾ç‰‡...</div>';let s="";yield Excel.run(t=>e(this,void 0,void 0,function*(){const e=t.workbook.getSelectedRange();if(e.load("address"),yield t.sync(),!e.address)throw new Error("è¯·å…ˆåœ¨Excelä¸­é€‰æ‹©ä¸€ä¸ªå•å…ƒæ ¼");s=e.address})),yield function(t,n,s){return e(this,void 0,void 0,function*(){yield Excel.run(i=>e(this,void 0,void 0,function*(){const e=i.workbook.worksheets.getActiveWorksheet(),o=e.getRange(n);o.load(["left","top","width","height"]),yield i.sync();const a=e.shapes.addImage(t);a.load("name"),a.left=o.left,a.top=o.top,a.width=Math.max(o.width,1),a.height=Math.max(o.height,1),a.lockAspectRatio=!1,a.placement=Excel.Placement.twoCell,yield i.sync(),s&&a.name&&(c.set(a.name,s),m(a.name,s))}))})}(d.base64,s,d.dataUrl),t.innerHTML='<div class="status success">âœ… å›¾ç‰‡å·²æˆåŠŸåµŒå…¥åˆ°å•å…ƒæ ¼ '+s+"</div>",n.style.display="none",d=null}catch(e){t.innerHTML='<div class="status error">âŒ é”™è¯¯: '+e.message+"</div>"}else t.innerHTML='<div class="status error">âŒ æ²¡æœ‰å¾…æ’å…¥çš„æˆªå›¾</div>'})}function h(){const e=document.getElementById("screenshotStatus");document.getElementById("screenshotPreviewArea").style.display="none",d=null,e.innerHTML='<div class="status">å·²å–æ¶ˆ</div>'}function f(){document.getElementById("imageModal").classList.remove("active")}function y(){switch(a){case"screenshot":return s;case"cell":return i;default:return n}}function p(e){const t=y(),n=o+e;if(n>=0&&n<t.length){o=n,document.getElementById("imageModal");const e=document.getElementById("modalImage"),s=document.getElementById("modalInfo");e.src=t[n].src,s.textContent=`${t[n].name} (${n+1} / ${t.length})`,E()}}function E(){const e=document.getElementById("modalPrev"),t=document.getElementById("modalNext"),n=y();e.style.visibility=o>0?"visible":"hidden",t.style.visibility=o<n.length-1?"visible":"hidden"}function I(e,s,i=!1){const c=document.getElementById(e);c&&(c.innerHTML="",s.forEach((s,d)=>{const l=document.createElement("div");l.className="image-item";const r=document.createElement("img");if(r.src=s.src,r.alt=s.name,r.title=`ç‚¹å‡»æŸ¥çœ‹å¤§å›¾: ${s.name}`,r.onclick=()=>function(e){if(e<0||e>=n.length)return;o=e,a="preview";const t=document.getElementById("imageModal"),s=document.getElementById("modalImage"),i=document.getElementById("modalInfo");s.src=n[e].src,i.textContent=`${n[e].name} (${e+1} / ${n.length})`,t.classList.add("active"),E()}(d),l.appendChild(r),i){const s=document.createElement("button");s.className="delete-btn",s.innerHTML="Ã—",s.title="åˆ é™¤æ­¤å›¾ç‰‡",s.onclick=s=>{s.stopPropagation(),function(e,s){t.splice(e,1),n.splice(e,1);const i=document.getElementById("selectedFiles"),o=document.getElementById("batchInsertBtn");t.length>0?(i.innerHTML=`<strong>å·²é€‰æ‹© ${t.length} å¼ å›¾ç‰‡ (ç‚¹å‡»å°å›¾æŸ¥çœ‹ï¼Œæ‚¬åœæ˜¾ç¤ºåˆ é™¤):</strong>`,I(s,n,!0)):(i.innerHTML="",document.getElementById(s).innerHTML="",o.disabled=!0)}(d,e)},l.appendChild(s)}c.appendChild(l)}))}function w(e){const s=e.target.files,i=document.getElementById("selectedFiles"),o=document.getElementById("batchInsertBtn");if(s&&s.length>0){t=Array.from(s),i.innerHTML=`<strong>å·²é€‰æ‹© ${s.length} å¼ å›¾ç‰‡ (ç‚¹å‡»å°å›¾æŸ¥çœ‹ï¼Œæ‚¬åœæ˜¾ç¤ºåˆ é™¤):</strong>`,o.disabled=!1,n=[];const e=t.map((e,t)=>new Promise(s=>{const i=new FileReader;i.onload=()=>{n[t]={src:i.result,name:e.name},s()},i.readAsDataURL(e)}));Promise.all(e).then(()=>{I("imagePreviewGrid",n,!0)})}else t=[],n=[],i.innerHTML="",document.getElementById("imagePreviewGrid").innerHTML="",o.disabled=!0}function L(){return e(this,void 0,void 0,function*(){const s=document.getElementById("batchStatus"),i=document.getElementById("batchInsertBtn");if(0!==t.length)try{i.disabled=!0,s.innerHTML='<div class="status">æ­£åœ¨å¤„ç†...</div>',yield Excel.run(i=>e(this,void 0,void 0,function*(){var e;const o=i.workbook.getSelectedRange();o.load(["address","cellCount","rowCount","columnCount"]),yield i.sync();const a=o.cellCount;if(a<t.length)throw new Error(`é€‰æ‹©çš„å•å…ƒæ ¼æ•°é‡(${a})å°‘äºå›¾ç‰‡æ•°é‡(${t.length})`);s.innerHTML='<div class="status">æ­£åœ¨åµŒå…¥å›¾ç‰‡,è¯·ç¨å€™...</div>';for(let s=0;s<t.length;s++){const a=t[s],d=yield B(a),l=(null===(e=n[s])||void 0===e?void 0:e.src)||"data:image/png;base64,"+d,r=Math.floor(s/o.columnCount),u=s%o.columnCount,g=o.getCell(r,u);g.load(["left","top","width","height","address"]),yield i.sync();const v=i.workbook.worksheets.getActiveWorksheet().shapes.addImage(d);v.load("name"),v.left=g.left,v.top=g.top,v.width=Math.max(g.width,1),v.height=Math.max(g.height,1),v.lockAspectRatio=!1,v.placement=Excel.Placement.twoCell,yield i.sync(),v.name&&(c.set(v.name,l),m(v.name,l))}s.innerHTML=`<div class="status success">âœ… æˆåŠŸåµŒå…¥ ${t.length} å¼ å›¾ç‰‡</div>`}))}catch(e){s.innerHTML='<div class="status error">âŒ é”™è¯¯: '+e.message+"</div>"}finally{setTimeout(()=>{i.disabled=!1},2e3)}else s.innerHTML='<div class="status error">âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡</div>'})}function B(e){return new Promise((t,n)=>{const s=new FileReader;s.onload=()=>{const e=s.result.split(",")[1];t(e)},s.onerror=n,s.readAsDataURL(e)})}function M(){return e(this,void 0,void 0,function*(){const t=document.getElementById("cellImageStatus"),n=(document.getElementById("cellImagePreview"),document.getElementById("getImagesBtn"));n.disabled=!0,t.innerHTML='<div class="status">æ­£åœ¨è·å–å›¾ç‰‡...</div>';try{yield Excel.run(s=>e(this,void 0,void 0,function*(){const e=s.workbook.worksheets.getActiveWorksheet();let o=0,a=0,d=0,l=0,r=!1;try{const e=s.workbook.getSelectedRange();e.load(["left","top","width","height","address"]),yield s.sync(),o=e.left,a=e.top,d=o+e.width,l=a+e.height,r=!0}catch(e){r=!1}const m=e.shapes;let u;if(m.load("items/type,items/name,items/left,items/top,items/width,items/height"),yield s.sync(),r){if(u=m.items.filter(e=>{if(e.type!==Excel.ShapeType.image)return!1;const t=e.left,n=e.top;return t>=o&&t<d&&n>=a&&n<l}),0===u.length)return t.innerHTML='<div class="status">é€‰ä¸­åŒºåŸŸå†…æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡<br><small>æç¤ºï¼šè¯·é€‰æ‹©åŒ…å«å›¾ç‰‡çš„å•å…ƒæ ¼</small></div>',void(n.disabled=!1);t.innerHTML=`<div class="status">åœ¨é€‰ä¸­åŒºåŸŸæ‰¾åˆ° ${u.length} å¼ å›¾ç‰‡ï¼Œæ­£åœ¨åŠ è½½...</div>`}else{if(u=m.items.filter(e=>e.type===Excel.ShapeType.image),0===u.length)return t.innerHTML='<div class="status">å½“å‰å·¥ä½œè¡¨æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡</div>',void(n.disabled=!1);t.innerHTML=`<div class="status">æ‰¾åˆ° ${u.length} å¼ å›¾ç‰‡ï¼Œæ­£åœ¨åŠ è½½...</div>`}i=[];for(const e of u)c.has(e.name);const g=[];for(let e=0;e<u.length;e++){const t=u[e];if(!c.has(t.name)){const n=t.getAsImage(Excel.PictureFormat.png);g.push({shape:t,result:n,index:e})}}g.length>0&&(yield s.sync());for(let e=0;e<u.length;e++){const t=u[e],n=t.name||`å›¾ç‰‡${e+1}`;if(c.has(t.name))i.push({src:c.get(t.name),name:n+" (åŸå›¾)"});else{const s=g.find(e=>e.shape===t);if(s)try{const e=s.result.value;e&&i.push({src:`data:image/png;base64,${e}`,name:n})}catch(t){console.error(`è·å–å›¾ç‰‡ ${e+1} å¤±è´¥:`,t)}}}0===i.length?t.innerHTML='<div class="status">æ— æ³•è¯»å–å›¾ç‰‡æ•°æ®</div>':(t.innerHTML=`<div class="status success">âœ… æˆåŠŸè·å– ${i.length} å¼ å›¾ç‰‡</div>`,function(){const e=document.getElementById("cellImagePreview");0!==i.length?e.innerHTML=i.map((e,t)=>`\n    <div class="image-preview-item" onclick="openCellImageModal(${t})">\n      <img src="${e.src}" alt="${e.name}" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">\n      <div class="image-name">${e.name}</div>\n    </div>\n  `).join(""):e.innerHTML=""}())}))}catch(e){t.innerHTML='<div class="status error">âŒ é”™è¯¯: '+e.message+"</div>"}finally{n.disabled=!1}})}function b(){i=[],document.getElementById("cellImagePreview").innerHTML="",document.getElementById("cellImageStatus").innerHTML=""}window.openCellImageModal=function(e){o=e,a="cell";const t=document.getElementById("imageModal"),n=document.getElementById("modalImage"),s=document.getElementById("modalInfo");i[e]&&(n.src=i[e].src,s.textContent=`${i[e].name} (${e+1} / ${i.length})`,t.classList.add("active"),E())}}})[579].call({});