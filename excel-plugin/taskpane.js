({579(){var e=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(s,o){function a(e){try{l(i.next(e))}catch(e){o(e)}}function d(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,d)}l((i=i.apply(e,t||[])).next())})};Office.onReady(t=>{t.host===Office.HostType.Excel&&(document.getElementById("screenshotBtn").onclick=p,document.getElementById("imageInput").onchange=w,document.getElementById("batchInsertBtn").onclick=I,document.getElementById("getImagesBtn").onclick=L,document.getElementById("clearPreviewBtn").onclick=b,function(){const e=document.getElementById("imageModal"),t=document.getElementById("modalClose"),n=document.getElementById("modalPrev"),i=document.getElementById("modalNext");t.onclick=g,e.onclick=t=>{t.target===e&&g()},n.onclick=()=>v(-1),i.onclick=()=>v(1),document.addEventListener("keydown",t=>{e.classList.contains("active")&&("Escape"===t.key&&g(),"ArrowLeft"===t.key&&v(-1),"ArrowRight"===t.key&&v(1))})}(),function(){const t=document.getElementById("pasteArea"),n=document.getElementById("screenshotStatus");t.setAttribute("tabindex","0"),t.onclick=()=>{t.classList.add("active"),t.focus(),n.innerHTML='<div class="status">✅ 粘贴区域已激活，现在按 ⌘+V 粘贴截图</div>'},t.addEventListener("paste",e=>{m(e)}),document.addEventListener("paste",e=>{m(e)}),t.addEventListener("blur",()=>{setTimeout(()=>{t.classList.remove("active")},300)}),t.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation(),t.classList.add("dragover")}),t.addEventListener("dragenter",e=>{e.preventDefault(),e.stopPropagation(),t.classList.add("dragover")}),t.addEventListener("dragleave",e=>{e.preventDefault(),t.classList.remove("dragover")}),t.addEventListener("drop",t=>{!function(t){e(this,void 0,void 0,function*(){var e;t.preventDefault(),document.getElementById("pasteArea").classList.remove("dragover");const n=document.getElementById("screenshotStatus"),i=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;if(!i||0===i.length)return void(n.innerHTML='<div class="status error">❌ 没有检测到文件</div>');const s=i[0];s.type.startsWith("image/")?yield u(s,s.name):n.innerHTML='<div class="status error">❌ 请拖拽图片文件</div>'})}(t)}),document.addEventListener("dragover",e=>e.preventDefault()),document.addEventListener("drop",e=>e.preventDefault())}(),function(){try{const e=Office.context.document.settings.get(c);if(!e)return;const t=JSON.parse(e);for(const e of t){const t=Office.context.document.settings.get(l+e);t&&d.set(e,t)}console.log(`已从文档加载 ${d.size} 张原图数据`)}catch(e){console.error("加载原图数据失败:",e)}}())});let t=[],n=[],i=[],s=[],o=0,a="preview";const d=new Map,l="originalImage_",c="originalImageIndex";function r(t,n){return e(this,void 0,void 0,function*(){try{Office.context.document.settings.set(l+t,n);const e=Office.context.document.settings.get(c);let i=e?JSON.parse(e):[];-1===i.indexOf(t)&&(i.push(t),Office.context.document.settings.set(c,JSON.stringify(i))),yield new Promise((e,t)=>{Office.context.document.settings.saveAsync(n=>{var i;n.status===Office.AsyncResultStatus.Succeeded?e():t(new Error((null===(i=n.error)||void 0===i?void 0:i.message)||"保存失败"))})})}catch(e){console.error("保存原图到文档失败:",e)}})}function m(t){return e(this,void 0,void 0,function*(){var e,n;t.preventDefault(),t.stopPropagation();const i=document.getElementById("screenshotStatus");i.innerHTML='<div class="status">正在读取剪贴板...</div>';const s=null===(e=t.clipboardData)||void 0===e?void 0:e.items;if(s){for(let e=0;e<s.length;e++){const t=s[e];if(t.type.startsWith("image/")){const e=t.getAsFile();if(e)return void(yield u(e))}}for(let e=0;e<s.length;e++){const t=s[e];if("file"===t.kind){const e=t.getAsFile();if(e&&e.type.startsWith("image/"))return void(yield u(e))}}}const o=null===(n=t.clipboardData)||void 0===n?void 0:n.files;if(o&&o.length>0)for(let e=0;e<o.length;e++){const t=o[e];if(t.type.startsWith("image/")||t.name.endsWith(".png")||t.name.endsWith(".jpg"))return void(yield u(t))}try{if(navigator.clipboard&&navigator.clipboard.read){const e=yield navigator.clipboard.read();for(const t of e){const e=t.types.filter(e=>e.startsWith("image/")||"public.png"===e||"public.tiff"===e);for(const n of e)try{const e=yield t.getType(n),i=new File([e],"clipboard-image.png",{type:"image/png"});return void(yield u(i))}catch(e){console.log("Failed to get type:",n,e)}for(const e of["image/png","image/jpeg","image/gif","image/webp"])try{const n=yield t.getType(e),i=new File([n],"clipboard-image.png",{type:e});return void(yield u(i))}catch(e){}}}}catch(e){console.log("Clipboard API error:",e)}i.innerHTML='<div class="status error">❌ 无法读取剪贴板图片<br><small>提示：macOS截图后，请尝试先打开"预览"应用粘贴，再复制一次</small></div>'})}function u(t,s){return e(this,void 0,void 0,function*(){const s=document.getElementById("screenshotStatus");try{s.innerHTML='<div class="status">正在处理图片...</div>';let o="";yield Excel.run(t=>e(this,void 0,void 0,function*(){const e=t.workbook.getSelectedRange();if(e.load("address"),yield t.sync(),!e.address)throw new Error("请先在Excel中选择一个单元格");o=e.address}));const a=yield new Promise((e,n)=>{const i=new FileReader;i.onload=()=>{const t=i.result;e(t.split(",")[1])},i.onerror=()=>n(new Error("读取图片失败")),i.readAsDataURL(t)}),d="data:image/png;base64,"+a;yield E(a,o,d),s.innerHTML='<div class="status success">✅ 图片已成功嵌入到单元格 '+o+"</div>",i=[],n=[],document.getElementById("screenshotPreview").innerHTML=""}catch(e){s.innerHTML='<div class="status error">❌ 错误: '+e.message+"</div>"}})}function g(){document.getElementById("imageModal").classList.remove("active")}function h(){switch(a){case"screenshot":return i;case"cell":return s;default:return n}}function v(e){const t=h(),n=o+e;if(n>=0&&n<t.length){o=n,document.getElementById("imageModal");const e=document.getElementById("modalImage"),i=document.getElementById("modalInfo");e.src=t[n].src,i.textContent=`${t[n].name} (${n+1} / ${t.length})`,y()}}function y(){const e=document.getElementById("modalPrev"),t=document.getElementById("modalNext"),n=h();e.style.visibility=o>0?"visible":"hidden",t.style.visibility=o<n.length-1?"visible":"hidden"}function f(e,i,s=!1){const d=document.getElementById(e);d&&(d.innerHTML="",i.forEach((i,l)=>{const c=document.createElement("div");c.className="image-item";const r=document.createElement("img");if(r.src=i.src,r.alt=i.name,r.title=`点击查看大图: ${i.name}`,r.onclick=()=>function(e){if(e<0||e>=n.length)return;o=e,a="preview";const t=document.getElementById("imageModal"),i=document.getElementById("modalImage"),s=document.getElementById("modalInfo");i.src=n[e].src,s.textContent=`${n[e].name} (${e+1} / ${n.length})`,t.classList.add("active"),y()}(l),c.appendChild(r),s){const i=document.createElement("button");i.className="delete-btn",i.innerHTML="×",i.title="删除此图片",i.onclick=i=>{i.stopPropagation(),function(e,i){t.splice(e,1),n.splice(e,1);const s=document.getElementById("selectedFiles"),o=document.getElementById("batchInsertBtn");t.length>0?(s.innerHTML=`<strong>已选择 ${t.length} 张图片 (点击小图查看，悬停显示删除):</strong>`,f(i,n,!0)):(s.innerHTML="",document.getElementById(i).innerHTML="",o.disabled=!0)}(l,e)},c.appendChild(i)}d.appendChild(c)}))}function p(){return e(this,void 0,void 0,function*(){const t=document.getElementById("screenshotStatus"),s=document.getElementById("screenshotBtn"),o=document.getElementById("cancelScreenshotBtn"),a=document.getElementById("screenshotOverlay");let d=0,l=0,c=0,r=0,m=!1,u=null,g=null,h=null,v=1,y=0,f=0,p="";function w(){a.style.display="none",a.innerHTML="",a.onmousedown=null,a.onmousemove=null,a.onmouseup=null,o.style.display="none",o.onclick=null,m=!1,u=null,h=null}try{if(s.disabled=!0,t.innerHTML='<div class="status">检查单元格选择...</div>',yield Excel.run(t=>e(this,void 0,void 0,function*(){const e=t.workbook.getSelectedRange();if(e.load("address"),yield t.sync(),!e.address)throw new Error("请先选择一个单元格");p=e.address})),t.innerHTML='<div class="status">请选择要截取的屏幕或窗口...</div>',g=yield function(){return e(this,void 0,void 0,function*(){if(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)throw new Error("当前环境不支持屏幕捕获");const e=yield navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1});try{const t=document.createElement("video");t.srcObject=e,yield new Promise(e=>{t.onloadedmetadata=()=>e()}),yield t.play();const n=document.createElement("canvas");return n.width=t.videoWidth,n.height=t.videoHeight,n.getContext("2d").drawImage(t,0,0,n.width,n.height),n}finally{e.getTracks().forEach(e=>e.stop())}})}(),!g)throw new Error("未能捕获屏幕");t.innerHTML='<div class="status">请在预览中框选截图区域...</div>',a.style.display="block",o.style.display="inline-block",a.style.cursor="crosshair",a.style.background="rgba(0,0,0,0.5)",h=document.createElement("canvas"),h.style.position="fixed",h.style.top="0",h.style.left="0",h.style.zIndex="9999",h.style.pointerEvents="none",h.width=a.clientWidth,h.height=a.clientHeight,a.appendChild(h);const I=h.getContext("2d"),M=h.width/g.width,L=h.height/g.height;v=Math.min(M,L);const b=g.width*v,B=g.height*v;y=(h.width-b)/2,f=(h.height-B)/2,I.fillStyle="rgba(0,0,0,0.5)",I.fillRect(0,0,h.width,h.height),I.drawImage(g,0,0,g.width,g.height,y,f,b,B);const T=g,x=v,H=y,k=f;a.onmousedown=e=>{m=!0,d=e.clientX,l=e.clientY,u||(u=document.createElement("div"),u.style.position="fixed",u.style.border="2px dashed #0078d4",u.style.background="rgba(0,120,212,0.2)",u.style.zIndex="10000",a.appendChild(u)),u.style.left=d+"px",u.style.top=l+"px",u.style.width="0px",u.style.height="0px"},a.onmousemove=e=>{if(!m||!u)return;c=e.clientX,r=e.clientY;const t=Math.min(d,c),n=Math.min(l,r),i=Math.abs(c-d),s=Math.abs(r-l);u.style.left=t+"px",u.style.top=n+"px",u.style.width=i+"px",u.style.height=s+"px"},a.onmouseup=o=>e(this,void 0,void 0,function*(){if(!m)return;m=!1,c=o.clientX,r=o.clientY;const e=Math.min(d,c),a=Math.min(l,r),u=Math.abs(c-d),g=Math.abs(r-l);if(u<10||g<10)return t.innerHTML='<div class="status error">❌ 选择区域太小，请重新选择</div>',w(),void(s.disabled=!1);const h=Math.max(0,(e-H)/x),v=Math.max(0,(a-k)/x),y=u/x,f=g/x;t.innerHTML='<div class="status">正在处理截图...</div>',w();try{const e=document.createElement("canvas");e.width=Math.floor(y),e.height=Math.floor(f),e.getContext("2d").drawImage(T,Math.floor(h),Math.floor(v),Math.floor(y),Math.floor(f),0,0,e.width,e.height);const s=yield(I=e,new Promise((e,t)=>{I.toBlob(n=>{if(!n)return void t(new Error("无法生成图片"));const i=new FileReader;i.onloadend=()=>{const t=i.result.split(",")[1];e(t)},i.onerror=()=>t(new Error("读取图片失败")),i.readAsDataURL(n)},"image/png")})),o="data:image/png;base64,"+s;yield E(s,p,o),t.innerHTML='<div class="status success">✅ 截图已成功嵌入到单元格 '+p+"</div>",i=[],n=[],document.getElementById("screenshotPreview").innerHTML=""}catch(e){t.innerHTML='<div class="status error">❌ 插入失败: '+e.message+"</div>"}var I;s.disabled=!1}),o.onclick=()=>{t.innerHTML='<div class="status">截图已取消</div>',w(),s.disabled=!1}}catch(e){t.innerHTML='<div class="status error">❌ 错误: '+e.message+"</div>",w(),s.disabled=!1}})}function E(t,n,i){return e(this,void 0,void 0,function*(){yield Excel.run(s=>e(this,void 0,void 0,function*(){const e=s.workbook.worksheets.getActiveWorksheet(),o=e.getRange(n);o.load(["left","top","width","height"]),yield s.sync();const a=e.shapes.addImage(t);a.load("name"),a.left=o.left,a.top=o.top,a.width=Math.max(o.width,1),a.height=Math.max(o.height,1),a.lockAspectRatio=!1,a.placement=Excel.Placement.twoCell,yield s.sync(),i&&a.name&&(d.set(a.name,i),r(a.name,i))}))})}function w(e){const i=e.target.files,s=document.getElementById("selectedFiles"),o=document.getElementById("batchInsertBtn");if(i&&i.length>0){t=Array.from(i),s.innerHTML=`<strong>已选择 ${i.length} 张图片 (点击小图查看，悬停显示删除):</strong>`,o.disabled=!1,n=[];const e=t.map((e,t)=>new Promise(i=>{const s=new FileReader;s.onload=()=>{n[t]={src:s.result,name:e.name},i()},s.readAsDataURL(e)}));Promise.all(e).then(()=>{f("imagePreviewGrid",n,!0)})}else t=[],n=[],s.innerHTML="",document.getElementById("imagePreviewGrid").innerHTML="",o.disabled=!0}function I(){return e(this,void 0,void 0,function*(){const i=document.getElementById("batchStatus"),s=document.getElementById("batchInsertBtn");if(0!==t.length)try{s.disabled=!0,i.innerHTML='<div class="status">正在处理...</div>',yield Excel.run(s=>e(this,void 0,void 0,function*(){var e;const o=s.workbook.getSelectedRange();o.load(["address","cellCount","rowCount","columnCount"]),yield s.sync();const a=o.cellCount;if(a<t.length)throw new Error(`选择的单元格数量(${a})少于图片数量(${t.length})`);i.innerHTML='<div class="status">正在嵌入图片,请稍候...</div>';for(let i=0;i<t.length;i++){const a=t[i],l=yield M(a),c=(null===(e=n[i])||void 0===e?void 0:e.src)||"data:image/png;base64,"+l,m=Math.floor(i/o.columnCount),u=i%o.columnCount,g=o.getCell(m,u);g.load(["left","top","width","height","address"]),yield s.sync();const h=s.workbook.worksheets.getActiveWorksheet().shapes.addImage(l);h.load("name"),h.left=g.left,h.top=g.top,h.width=Math.max(g.width,1),h.height=Math.max(g.height,1),h.lockAspectRatio=!1,h.placement=Excel.Placement.twoCell,yield s.sync(),h.name&&(d.set(h.name,c),r(h.name,c))}i.innerHTML=`<div class="status success">✅ 成功嵌入 ${t.length} 张图片</div>`}))}catch(e){i.innerHTML='<div class="status error">❌ 错误: '+e.message+"</div>"}finally{setTimeout(()=>{s.disabled=!1},2e3)}else i.innerHTML='<div class="status error">❌ 请先选择图片</div>'})}function M(e){return new Promise((t,n)=>{const i=new FileReader;i.onload=()=>{const e=i.result.split(",")[1];t(e)},i.onerror=n,i.readAsDataURL(e)})}function L(){return e(this,void 0,void 0,function*(){const t=document.getElementById("cellImageStatus"),n=(document.getElementById("cellImagePreview"),document.getElementById("getImagesBtn"));n.disabled=!0,t.innerHTML='<div class="status">正在获取图片...</div>';try{yield Excel.run(i=>e(this,void 0,void 0,function*(){const e=i.workbook.worksheets.getActiveWorksheet().shapes;e.load("items/type,items/name"),yield i.sync();const o=e.items.filter(e=>e.type===Excel.ShapeType.image);if(0===o.length)return t.innerHTML='<div class="status">当前工作表没有找到图片</div>',void(n.disabled=!1);t.innerHTML=`<div class="status">找到 ${o.length} 张图片，正在加载...</div>`,s=[];for(const e of o)d.has(e.name);const a=[];for(let e=0;e<o.length;e++){const t=o[e];if(!d.has(t.name)){const n=t.getAsImage(Excel.PictureFormat.png);a.push({shape:t,result:n,index:e})}}a.length>0&&(yield i.sync());for(let e=0;e<o.length;e++){const t=o[e],n=t.name||`图片${e+1}`;if(d.has(t.name))s.push({src:d.get(t.name),name:n+" (原图)"});else{const i=a.find(e=>e.shape===t);if(i)try{const e=i.result.value;e&&s.push({src:`data:image/png;base64,${e}`,name:n})}catch(t){console.error(`获取图片 ${e+1} 失败:`,t)}}}0===s.length?t.innerHTML='<div class="status">无法读取图片数据</div>':(t.innerHTML=`<div class="status success">✅ 成功获取 ${s.length} 张图片</div>`,function(){const e=document.getElementById("cellImagePreview");0!==s.length?e.innerHTML=s.map((e,t)=>`\n    <div class="image-preview-item" onclick="openCellImageModal(${t})">\n      <img src="${e.src}" alt="${e.name}" title="点击查看大图">\n      <div class="image-name">${e.name}</div>\n    </div>\n  `).join(""):e.innerHTML=""}())}))}catch(e){t.innerHTML='<div class="status error">❌ 错误: '+e.message+"</div>"}finally{n.disabled=!1}})}function b(){s=[],document.getElementById("cellImagePreview").innerHTML="",document.getElementById("cellImageStatus").innerHTML=""}window.openCellImageModal=function(e){o=e,a="cell";const t=document.getElementById("imageModal"),n=document.getElementById("modalImage"),i=document.getElementById("modalInfo");s[e]&&(n.src=s[e].src,i.textContent=`${s[e].name} (${e+1} / ${s.length})`,t.classList.add("active"),y())}}})[579].call({});